#───────────────────────────────────────────────────────────────────
# 1) upshow/pm2:node22 이미지를 베이스로 사용
#───────────────────────────────────────────────────────────────────
FROM upshow/pm2:node22

# 작업 디렉토리를 /app 으로 설정
WORKDIR /app

#───────────────────────────────────────────────────────────────────
# 2) pnpm 활성화 & 의존성 설치
#───────────────────────────────────────────────────────────────────
#    keymetrics/pm2:latest-alpine에는 corepack이 없으므로, npm을 통해 pnpm을 설치합니다.
RUN npm install -g pnpm@10.11.0

# 패키지 잠금 파일(pnpm-lock.yaml)과 package.json만 먼저 복사
COPY package.json pnpm-lock.yaml ./

# pnpm으로 모든 의존성을 설치
RUN pnpm install

#───────────────────────────────────────────────────────────────────
# 3) 소스 전체 복사 & Next.js 프로덕션 빌드
#───────────────────────────────────────────────────────────────────
COPY . .

# Next.js를 production 모드로 빌드 (package.json에 "build": "next build" 정의 필요)
RUN pnpm run build

#───────────────────────────────────────────────────────────────────
# 4) 환경 변수 설정 & 포트 노출
#───────────────────────────────────────────────────────────────────
ENV NODE_ENV=production
EXPOSE 3000

#───────────────────────────────────────────────────────────────────
# 5) PM2로 Next.js 프로덕션 서버 구동
#───────────────────────────────────────────────────────────────────
# pm2-runtime을 사용해서 "pnpm start" (즉, "next start -p 3000") 명령을 실행
CMD ["pm2-runtime", "start", "pnpm", "--", "start"]
